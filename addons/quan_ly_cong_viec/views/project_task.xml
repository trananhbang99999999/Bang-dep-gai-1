<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- =========================
         TREE VIEW
    ========================== -->
    <record id="view_project_task_tree" model="ir.ui.view">
      <field name="name">project_task.tree</field>
      <field name="model">project_task</field>
      <field name="arch" type="xml">
        <tree string="Danh sách công việc" decoration-danger="is_overdue" decoration-success="state == 'done'" decoration-warning="progress &lt; 50 and state == 'doing'">
          <field name="project_task_id"/>
          <field name="name"/>
          <field name="customer_id"/>
          <field name="phong_ban_id"/>
          <field name="nhan_vien_id"/>
          <field name="priority" widget="badge"/>
          <field name="difficulty"/>
          <field name="progress" widget="progressbar"/>
          <field name="deadline"/>
          <field name="days_remaining" widget="integer"/>
          <field name="state" widget="badge" decoration-success="state == 'done'" decoration-danger="state == 'cancel'"/>
          <field name="is_overdue"/>
        </tree>
      </field>
    </record>

    <!-- =========================
         FORM VIEW
    ========================== -->
    <record id="view_project_task_form" model="ir.ui.view">
      <field name="name">project_task.form</field>
      <field name="model">project_task</field>
      <field name="arch" type="xml">
        <form string="Công việc">
          <header>
            <button name="action_start" type="object" string="Bắt đầu"
                    states="todo" class="btn-primary"/>
            <button name="action_done" type="object" string="Hoàn thành"
                    states="todo,doing" class="btn-success"/>
            <button name="action_cancel" type="object" string="Hủy"
                    states="todo,doing" class="btn-secondary"/>

            <field name="state" widget="statusbar"
                   statusbar_visible="todo,doing,done,cancel"/>
          </header>

          <sheet>
            <div class="alert alert-warning" attrs="{'invisible': [('is_overdue', '=', False)]}">
              <strong>⚠️ Cảnh báo:</strong> Công việc này đã <strong>quá hạn</strong>!
            </div>

            <div class="row">
              <div class="col-md-6">
                <group>
                  <field name="project_task_id" readonly="1"/>
                  <field name="name"/>
                  <field name="customer_id"/>
                  
                </group>
              </div>
              <div class="col-md-6">
                <group>
                  <field name="priority" widget="selection"/>
                  <field name="difficulty" widget="selection"/>
                  <field name="progress"/>
                </group>
              </div>
            </div>

            <group string="Phân công">
              <field name="phong_ban_id" options="{'no_create': False}"/>
              <field name="nhan_vien_id"
                     domain="[('phong_ban_id','=',phong_ban_id)]"
                     context="{'default_phong_ban_id': phong_ban_id}"/>
              <field name="team_member_ids"
                     domain="[('phong_ban_id','=',phong_ban_id)]"
                     widget="many2many_tags"/>
            </group>

            <group string="Thời gian" col="2">
              <group>
                <field name="deadline" widget="date"/>
                <field name="days_remaining" readonly="1" attrs="{'invisible': [('deadline', '=', False)]}"/>
              </group>
              <group>
                <field name="estimated_hours"/>
                <field name="actual_hours"/>
              </group>
            </group>

            <group>
              <field name="actual_completion_date" readonly="1"/>
              <field name="is_overdue" readonly="1"/>
            </group>

            <notebook>
              <page string="Mô tả">
                <field name="description"/>
              </page>

              <page string="Trao đổi">
                <field name="message_follower_ids" widget="mail_followers"/>
                <field name="activity_ids" widget="mail_activity"/>
                <field name="message_ids" widget="mail_thread"/>
              </page>
            </notebook>
          </sheet>
        </form>
      </field>
    </record>

    <!-- =========================
         SEARCH VIEW
    ========================== -->
    <record id="view_project_task_search" model="ir.ui.view">
      <field name="name">project_task.search</field>
      <field name="model">project_task</field>
      <field name="arch" type="xml">
        <search string="Tìm công việc">
          <field name="project_task_id" string="Mã công việc"/>
          <field name="name" string="Tên công việc"/>
          <field name="customer_id"/>
          <field name="phong_ban_id"/>
          <field name="nhan_vien_id"/>
          <field name="project_category_id"/>
          <field name="state"/>
          <field name="priority"/>
          <field name="deadline"/>

          <separator/>

          <!-- ✅ THÊM: Lọc theo trạng thái -->
          <filter name="filter_todo" string="Cần làm"
                  domain="[('state','=','todo')]"/>
          <filter name="filter_doing" string="Đang làm"
                  domain="[('state','=','doing')]"/>
          <filter name="filter_done" string="Hoàn thành"
                  domain="[('state','=','done')]"/>
          <filter name="filter_cancel" string="Đã hủy"
                  domain="[('state','=','cancel')]"/>

          <separator/>

          <!-- ✅ THÊM: Lọc theo ưu tiên -->
          <filter name="filter_urgent" string="Khẩn cấp"
                  domain="[('priority','=','urgent')]"/>
          <filter name="filter_high" string="Ưu tiên cao"
                  domain="[('priority','=','high')]"/>

          <separator/>

          <!-- ✅ THÊM: Lọc theo deadline -->
          <filter name="filter_overdue" string="Quá hạn"
                  domain="[('is_overdue','=',True)]"/>
          <filter name="filter_due_today" string="Hạn hôm nay"
                  domain="[('deadline','=',context_today().strftime('%Y-%m-%d'))]"/>

          <separator/>

          <!-- ✅ THÊM: Lọc theo tiến độ -->
          <filter name="filter_not_started" string="Chưa bắt đầu"
                  domain="[('progress','=',0)]"/>
          <filter name="filter_in_progress" string="Đang thực hiện"
                  domain="[('progress','&gt;',0), ('progress','&lt;',100)]"/>

          <group expand="0" string="Nhóm theo">
            <filter name="group_state" string="Trạng thái"
                    context="{'group_by':'state'}"/>
            <filter name="group_priority" string="Mức độ ưu tiên"
                    context="{'group_by':'priority'}"/>
            <filter name="group_difficulty" string="Mức độ khó"
                    context="{'group_by':'difficulty'}"/>
            <filter name="group_department" string="Bộ phận"
                    context="{'group_by':'phong_ban_id'}"/>
            <filter name="group_employee" string="Nhân viên"
                    context="{'group_by':'nhan_vien_id'}"/>
            <filter name="group_customer" string="Khách hàng"
                    context="{'group_by':'customer_id'}"/>
            
            <filter name="group_deadline" string="Deadline"
                    context="{'group_by':'deadline'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- =========================
         ACTION
    ========================== -->
    <record id="action_project_task" model="ir.actions.act_window">
      <field name="name">Công việc</field>
      <field name="res_model">project_task</field>
      <field name="view_mode">tree,form</field>
      <field name="search_view_id" ref="view_project_task_search"/>
      <field name="view_id" ref="view_project_task_tree"/>
    </record>

    

  </data>
</odoo>
